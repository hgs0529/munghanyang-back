<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mul.com.sns.dao.CommentDao">

<!-- 특정 게시물에 따라 댓글과 대댓글 불러오기 -->
<select id="getComment" parameterType="Integer" resultType="mul.com.sns.dto.CommentDto">
	SELECT * FROM COMMENT 
	WHERE PHOTOID = (SELECT SEQ FROM (SELECT SEQ FROM PHOTO WHERE SEQ = #{seq}) A ) 
	ORDER BY REF DESC, STEP ASC
</select>

<!-- 특정 게시물의 댓글의 갯수(대댓글 포함) -->
<select id="countComment" parameterType="mul.com.sns.dto.CommentDto" resultType="Integer">
	SELECT COUNT(*) FROM COMMENT 
	WHERE PHOTOID = (SELECT SEQ FROM (SELECT SEQ FROM PHOTO WHERE SEQ = #{seq}) A )
</select>

<!-- 특정 댓글이 가지는 대댓글의 갯수 -->
<select id="countAnswerComment" parameterType="mul.com.sns.dto.CommentDto" resultType="Integer">
	SELECT COUNT(*) FROM COMMENT 
	WHERE REF = #{ref} AND STEP > 0
</select>

<!-- 특정 게시물에 댓글 추가하기 -->
<insert id="addComment" parameterType="mul.com.sns.dto.CommentDto" >
	INSERT INTO COMMENT(USERID, PHOTOID, CONTENT, REF, STEP, CDATE)
	VALUES(#{userid}, #{photoid}, #{content}, (SELECT IFNULL(MAX(REF), 0) + 1 FROM COMMENT b), 0, NOW() )
</insert>

<!-- 새 대댓글 추가하면 기존 대댓글의 스텝을 증가 -->
<update id="stepAnswerComment" parameterType="Integer">
	UPDATE COMMENT
	SET STEP=STEP+1
	WHERE REF=(SELECT REF FROM (SELECT REF FROM COMMENT A WHERE SEQ=#{seq}) A2)
		AND STEP > (SELECT STEP FROM (SELECT STEP FROM COMMENT B WHERE SEQ=#{seq}) B2)
</update>

<!-- 특정 댓글에 대댓글 추가하기 -->
<insert id="addAnswerComment" parameterType="mul.com.sns.dto.CommentDto" >
	INSERT INTO COMMENT(USERID, PHOTOID, CONTENT, REF, STEP, CDATE)
	VALUES(#{userid}, #{photoid}, #{content}, 
			(SELECT REF FROM COMMENT A WHERE SEQ=#{seq}),
			(SELECT STEP FROM COMMENT A WHERE SEQ=#{seq}) + 1,
			 NOW() )
</insert>

<!-- 특정 게시물의 댓글 삭제 (대댓글도 함께 날림) -->
<delete id="deleteComment" parameterType="mul.com.sns.dto.CommentDto">
	DELETE FROM COMMENT
	WHERE SEQ = #{seq}
</delete>

<!-- 특정 게시물의 최신 댓글 몇개만 보여주기 -->
<select id="getLatestComment" resultType="mul.com.sns.dto.CommentDto">
	
</select>

</mapper>

